---
title: Analyzing Gunshot Detection Data in DC
author: Seth Goldman
date: '2019-12-30'
slug: analyzing-gunshot-detection-data-in-dc
categories:
  - rstats
  - dc
tags:
  - DC
  - rstats
  - public datasets
---

```{r load_pkgs, echo = FALSE, message = FALSE, warning = FALSE}
library(readxl)
library(dplyr)
library(readr)
library(lubridate)
library(ggmap)
library(scales)
library(knitr)

# read files
spotshotter_data <- readRDS("SpotShotter_Data_as_of_q3_2019.RDS") %>% 
   mutate("month" = month(Datetime,label = TRUE),
         "year" = year(Datetime),
         "month_year" = floor_date(Datetime,unit = "month"))



```



Washington, D.C. uses a system called [SpotShotter](https://www.shotspotter.com/technology/), which involves acoustic sensors that can detect the presence and location of gunshots. The devices, which I believe are usually attached to utility poles, also transmit alerts to law enforcement, who can then respond to the incident. The city also makes the data publicly available on a quarterly basis via [Open Data DC](https://opendata.dc.gov/datasets/shot-spotter-gun-shots). 

This is an incredibly sad topic, as the data here is mostly generated by real acts of violence throughout the city. I decided to explore this data out of concern for what seems like an increase in gun violence in the city over the past few years.

Sadly, there are have been several thousand incidents logged by the SpotShotter system since 2014, which is the earliest date that public data is available. This post will be a quick exploration of the publicly-available data covering January 2014 through September 2019.

#### Background on the Data
The [data dictionary](https://mpdc.dc.gov/publication/shotspotter-data-disclaimer-and-dictionary) provided by the Metropolitan Police Department (MPD) suggests that all recorded SpotShotter incidents are released to the public via these reports. The District has been using SpotShotter since 2006, but has added additional sensors over the years: 300 according to [Washington Post](https://www.washingtonpost.com/investigations/shotspotter-detection-system-documents-39000-shooting-incidents-in-the-district/2013/11/02/055f8e9c-2ab1-11e3-8ade-a1f23cda135e_story.html) in 2013.


#### Geolocation  
One of the more interesting features of SpotShotter is its ability to analyze the sound waves to pinpoint the origin of a gunshot with with accuracy within 100 meters of its source. To visualize this, I am using the `ggmap` package, which combines the Google Maps API with the `ggplot2` data visualization package. Recently, Google started requiring users of this API to register via the Google Cloud Platform (GCP). There is a nice walkthrough of this process on the [Little Miss Data blog](https://www.littlemissdata.com/blog/maps).

#### Overview of the Data  

There were `r comma(n_distinct(spotshotter_data$ID))` incidents reported by SpotShotter between `r min(spotshotter_data$Datetime)` and `r max(spotshotter_data$Datetime)`.


```{r incidents_by_year, echo = FALSE, warning = FALSE, message = FALSE}
spotshotter_data %>% 
  group_by("year"=floor_date(Datetime,unit = "year")) %>% 
  summarize("incidents" = n_distinct(ID)) %>% 
  ggplot(aes(x=year,y=incidents))+
  geom_bar(stat = "identity")+
  geom_text(aes(label = incidents))+
  ggtitle("SpotShotter Incidents by Year",
          subtitle = "2019 data is through Q3")


```

It seems that there has been a decline in incidents since 2014. The 2019 total will likely surpass the 2017 and 2018 totals, as it is only including incidents recorded through September 30, 2019. Also, the documentation suggests that the SpotShotter software has improved over the years to more accurately distinguish fireworks from gunshots.

```{r incidents_by_type, echo = FALSE, warning = FALSE, message = FALSE}

spotshotter_data %>% 
  count(year,Type,name = "incidents") %>% 
  ggplot(aes(x=year, y = incidents, fill = Type))+
  geom_col()+
  geom_text(aes(label = incidents),
              position = position_stack(vjust = .5))+
  ggtitle("SpotShotter Incidents by Type")

```
It's curious to see the `Gunshot or Firecracker` classification increase so signifigantly in 2019. 

```{r incidents_by_month, echo = FALSE, warning = FALSE, message = FALSE}

spotshotter_data %>% 
  count(year,month,name = "incidents") %>% 
  ggplot(aes(x=year,y=incidents, fill = month))+
  geom_col(position = "fill")+
  ggtitle("SpotShotter Incidents by Month",
          subtitle = "on a relative basis")


```
July of 2014 and 2015 recorded an extremely high number of incidents. This is due to Independence Day fireworks, typically recorded after midnight (i.e., July 5). The July days with the most incidents in 2014-15 are displayed below.

```{r top_july_days, echo = FALSE}
spotshotter_data %>% 
  filter(year %in% c(2014,2015),
         month =="Jul") %>% 
  count(floor_date(Datetime,unit = "day"),sort = TRUE) %>% 
  rename("day" = 1,
         "incidents" = 2) %>% 
  head() %>% 
  kable()
```


In addition to the longitude/latitude coordinates, the data also includes a `Source` field, which corresponds with the MPD District that the incident took place in. The majority of incidents were recorded in Districts 6 and 7, which more-or-less overlap with Wards 7 and 8. District 3 had the fewest incidents recorded over the full period. The 2nd District doesn't appear at all in the data. It's unclear how many SpotShotter sensors are installed in each of the policing boundaries. The table below describes the total number of incidents sourced by each police district, and the graphs below that shows the share of reports by Source by year, on a relative and absolute basis. 

```{r by_source, echo = FALSE, warning = FALSE, message = FALSE}

spotshotter_data %>% 
  count(Source, 
        name = "incidents",
        sort = TRUE) %>% 
  kable()
  
spotshotter_data %>% 
  count(Source,year,name = "incidents") %>% 
  ggplot(aes(x=year,y=incidents, fill = Source))+
  geom_col(position = "fill")+
  ggtitle("SpotShotter incidents by Source",
          subtitle = "on an relative basis")


spotshotter_data %>% 
  count(Source,year,name = "incidents") %>% 
  ggplot(aes(x=year,y=incidents, fill = Source,position = "stack"))+
  geom_col()+
  ggtitle("SpotShotter incidents by Source",
          subtitle = "on an absolute basis")

```

#### Visualizing on the DC Map

This is my first time working with `ggmap`, and I'm relying heavily on the examples shared in the blogpost reference earlier.

This is a density map showing the relative frequency of indicents in various throughout the city.

``` {r get_maps, echo= FALSE, warning = FALSE, message = FALSE}
# get a map of DC from the Google Maps API
dc_map <- ggmap(get_googlemap(center = "washingon dc",
                              zoom = 12,
                              scale = 2,
                              maptype = "terrain"))

dc_satellite <- ggmap(get_googlemap(center = "washingon dc",
                              zoom = 12,
                              scale = 2,
                              maptype = "satellite"))



# try to get a map of even closer
neighborhood_zoom <- ggmap(get_googlemap(center = "park view dc",
                                         zoom = 15,
                                         scale = 2,
                              maptype = "terrain"))

```

```{r density_by_year, echo= FALSE, warning = FALSE, message = FALSE}


dc_map +
stat_density2d(data=spotshotter_data,
               aes(x=Longitude,y=Latitude),
               size=0.1,bins=15)+
  facet_wrap(~year)


```

This closely mirrors the summary of incidents by Source (i.e., MPD Districts), where there is a high concentration of incidents east of the Anacostia River. It's still unclear how concentrated the sensors are, so this should be taken with a grain of salt.

Next, I want to zoom in on the region near where I live, which is within the Third District. This can be done with the same code, but by using the Maps API to center the base map on a particular neighborhood, instead of having the Maps API center the map on *Washington, DC* in general.

For example:
```
neighborhood_zoom <- ggmap(get_googlemap(center = "park view dc",
                                         zoom = 15,
                                         scale = 2,
                              maptype = "terrain"))
```

```{r neighborhood_by_year,  echo= FALSE, warning = FALSE, message = FALSE}
neighborhood_zoom+
stat_density2d(data=spotshotter_data,
               aes(x=Longitude,y=Latitude),
               size=0.4,bins=10)+
  facet_wrap(~year)

```
Unlike the city-level density, the neighborhood-level density seems to show fairly dramatic changes in locations from year to year.

It's somewhat difficult to tell where exactly the high frequency areas are at the current zoom level. This final map looks at the past year of available data, which hopefully improves the readibility.

```{r neighborhood_last_year,  echo= FALSE, warning = FALSE, message = FALSE}

last_year_spotshotter <- spotshotter_data %>% 
  filter(Datetime >= (max(as.Date(Datetime) - 365)))  #filter on a rolling 365
  
neighborhood_zoom+
stat_density2d(data=last_year_spotshotter,
               aes(x=Longitude,y=Latitude),
               size=0.5,bins=10)+
  ggtitle("SpotShotter Incident Density - Neighborhood Zoom",
          subtitle = "Based on the last year of available data")

```

Lastly, a quick plot on the number of incidents recorded by day of week and time of day.


```{r time_of_day_in_last_year,  echo= FALSE, warning = FALSE, message = FALSE}

time_of_day_summary <- 
  last_year_spotshotter %>% 
  mutate("day_of_week" = wday(as.Date(Datetime),label = TRUE),
         "hour_of_day" = hour(Datetime)) %>% 
  group_by(day_of_week, hour_of_day) %>% 
  summarise("incidents" = n()) 
  
time_of_day_summary %>% 
  ggplot(aes(x=factor(hour_of_day),y=day_of_week, fill = incidents))+
  geom_tile()+
  scale_fill_gradient(low="white", high = "black")+
  xlab("Hour of Day (EST)")+
  ylab("")+
  ggtitle("SpotShotter Incidents by Hour",
          subtitle = "Based on the last year of available data")+
  guides(fill=guide_legend(title="# of Incidents")) +
  theme_bw()+
  theme_minimal()

```

It seems like the majority of incidents take place during the overnight hours on weekends. There appears to have been quite a few incidents recorded on Tuesdays between midnight at 1AM. I may dig into this at a later time.

In the future, I would look at stripping out the July 4th incidents, which may be skewing some of the trends. 


It has been a terrible year for gun violence in the District, with [seemingly daily](https://www.google.com/search?q=dc+gun+violence&sxsrf=ACYBGNSerUAqXj_Q06JeEHheKfuBiVcXmw:1577739242734&source=lnms&tbm=nws&sa=X&ved=2ahUKEwjH2PHYoN7mAhXRJt8KHbJLB-cQ_AUoAXoECAsQAw&biw=1216&bih=668) reports in the news. Hoping for a much more peaceful 2020.